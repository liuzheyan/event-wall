<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¹´ä¼šå¼¹å¹• - å¤§å±ç«¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI";
      color: #fff;
    }

    /* ===== å¤§å±ç«¯æ ·å¼ ===== */
    .screen-page {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    .mask {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 0;
    }

    .danmu {
      position: absolute;
      z-index: 1;
      white-space: nowrap;
      font-size: 24px;
      color: #fff;
      animation: move linear forwards;
      text-shadow: 0 0 8px rgba(0,0,0,0.8);
    }

    @keyframes move {
      from { transform: translateX(100vw); }
      to { transform: translateX(-100%); }
    }

    /* æ§åˆ¶é¢æ¿ */
    .control-panel {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 10;
    }

    .control-panel button {
      margin-left: 6px;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      color: #fff;
    }

    /* äºŒç»´ç å®¹å™¨ */
    .qr-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 20;
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      backdrop-filter: blur(4px);
    }
    
    .qr-container p {
      margin: 10px 0 0;
      font-size: 14px;
      color: #fff;
      font-weight: 500;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- å¼•å…¥ MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

<div id="app" class="screen-page">
  <div class="mask"></div>
  <div class="control-panel">
    <button id="toggle">â¸ æš‚åœ</button>
    <button id="clear">ğŸ§¹ æ¸…å±</button>
    <button id="download" style="display: none;">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
  </div>
  
  <!-- äºŒç»´ç å±•ç¤ºåŒº -->
  <div class="qr-container">
    <div id="qrcode"></div>
    <p>æ‰«ç å‘é€å¼¹å¹•</p>
    <p id="topic-display" style="font-size: 10px; color: #aaa; margin-top: 4px;"></p>
  </div>
</div>

<script src="js/config.js"></script>
<script>
  /** ===== é…ç½® ===== */
  // ä» CONFIG å¯¹è±¡ä¸­è¯»å–
  const { TRACK_COUNT, TRACK_HEIGHT, BG_IMAGE } = CONFIG;

  // è®¾ç½®èƒŒæ™¯å›¾
  document.getElementById("app").style.backgroundImage = `url(${BG_IMAGE})`;

  /** ===== é€šä¿¡é¢‘é“ (MQTT) ===== */
  // ä¼˜å…ˆä½¿ç”¨ CONFIG ä¸­çš„å›ºå®š Topicï¼Œæ–¹ä¾¿è°ƒè¯•
  // å¦‚æœéœ€è¦æ¯æ¬¡éšæœºï¼Œå¯ä»¥åœ¨ config.js ä¸­ä¿®æ”¹ï¼Œæˆ–è€…è¿™é‡Œè¦†ç›–
  let topic = CONFIG.MQTT_TOPIC;
  
  // æ˜¾ç¤ºå½“å‰ Topic
  document.getElementById("topic-display").innerText = "é¢‘é“: " + topic.split("/").pop(); // åªæ˜¾ç¤ºæœ€åä¸€æ®µ
  
  console.log("Connecting to MQTT Broker:", CONFIG.MQTT_BROKER);
  console.log("Topic:", topic);

  const client = mqtt.connect(CONFIG.MQTT_BROKER);

  client.on('connect', () => {
    console.log('MQTT Connected');
    client.subscribe(topic, (err) => {
      if (!err) {
        console.log('Subscribed to', topic);
        // === æ–°å¢ï¼šå¤§å±ç«¯ä¸Šçº¿å¹¿æ’­ ===
        // å‘Šè¯‰æ‰€æœ‰æ‰‹æœºç«¯ï¼šå¤§å±å·²åœ¨çº¿ï¼Œåœæ­¢ä½ ä»¬çš„æœ¬åœ°å¾ªç¯ï¼Œå¬æˆ‘æŒ‡æŒ¥
        try {
            client.publish(topic, JSON.stringify({ type: "control", action: "sync_start" }));
        } catch(e) {}
        // === ç»“æŸæ–°å¢ ===
      }
    });
  });

  /** ===== é€»è¾‘ ===== */
  const app = document.getElementById("app");
  let track = 0;
  let paused = false;
  let lastUserDanmuTime = 0; // ä¸Šæ¬¡æ’­æ”¾ç”¨æˆ·å¼¹å¹•çš„æ—¶é—´

  // å¾…æ’­æ”¾é˜Ÿåˆ—ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œå­˜æ”¾å®æ—¶æ¥æ”¶çš„ç”¨æˆ·å¼¹å¹•ï¼‰
  const pendingDanmus = [];
  // ç”¨æˆ·å¼¹å¹•å†å²ï¼ˆç”¨äºè®°å½•å’Œå›æ”¾ï¼‰
  // å°è¯•ä» LocalStorage è¯»å–å†å²
  let userDanmuHistory = [];

  // === è½¨é“ç®¡ç†ç³»ç»Ÿ ===
  // è®°å½•æ¯ä¸ªè½¨é“ä¸Šæ¬¡ä½¿ç”¨çš„æ—¶é—´
  const lastTrackTime = new Array(TRACK_COUNT).fill(0);

  function getSmartTrack() {
    const now = Date.now();
    const MIN_INTERVAL = 2000; // æœ€å°é—´éš” 2 ç§’
    
    // è®¡ç®—æ¯ä¸ªè½¨é“çš„ç©ºé—²æ—¶é—´
    const trackStates = lastTrackTime.map((time, index) => ({
        index,
        idleTime: now - time
    }));

    // ç­›é€‰å‡ºç©ºé—²æ—¶é—´è¶…è¿‡é˜ˆå€¼çš„è½¨é“
    const validCandidates = trackStates.filter(t => t.idleTime > MIN_INTERVAL);

    let selectedTrack;

    if (validCandidates.length > 0) {
        // å¦‚æœæœ‰æ»¡è¶³æ¡ä»¶çš„è½¨é“ï¼Œä»ä¸­éšæœºé€‰ä¸€ä¸ª
        // ä¼˜å…ˆé€‰ç©ºé—²æœ€ä¹…çš„å‡ ä¸ªï¼Œé˜²æ­¢æ€»æ˜¯éšæœºåˆ°åˆšè¿‡çº¿çš„
        validCandidates.sort((a, b) => b.idleTime - a.idleTime);
        // å–å‰ 50% çš„ç©ºé—²è½¨é“è¿›è¡Œéšæœºï¼Œå¢åŠ éšæœºæ€§
        const poolSize = Math.max(1, Math.ceil(validCandidates.length * 0.5));
        const pool = validCandidates.slice(0, poolSize);
        selectedTrack = pool[Math.floor(Math.random() * pool.length)].index;
    } else {
        // å¦‚æœéƒ½å¿™ï¼Œé€‰ç©ºé—²æ—¶é—´æœ€é•¿çš„é‚£ä¸ªï¼ˆè™½ç„¶ä¹Ÿä¸å¤Ÿ2ç§’ï¼Œä½†æ˜¯æœ€ä¹…æ²¡ç”¨çš„ï¼‰
        trackStates.sort((a, b) => b.idleTime - a.idleTime);
        selectedTrack = trackStates[0].index;
    }

    // æ›´æ–°æ—¶é—´
    lastTrackTime[selectedTrack] = now;
    return selectedTrack;
  }
  // === ç»“æŸè½¨é“ç®¡ç† ===

  try {
    const saved = localStorage.getItem("danmu_history");
    if (saved) userDanmuHistory = JSON.parse(saved);
  } catch(e) {}

  function saveHistory() {
      // åªä¿ç•™æœ€è¿‘ 200 æ¡
      if (userDanmuHistory.length > 200) {
          userDanmuHistory = userDanmuHistory.slice(-200);
      }
      localStorage.setItem("danmu_history", JSON.stringify(userDanmuHistory));
  }

  // è·å–éšæœºäº®è‰²
  function getRandomColor() {
    const letters = '89ABCDEF'; // é¿å…å¤ªæš—çš„é¢œè‰²
    let color = '#';
    for (let i = 0; i < 6; i++) {
      // ä¿®å¤ï¼šå­—ç¬¦é›†é•¿åº¦ä¸º 8
      color += letters[Math.floor(Math.random() * 8)];
    }
    return color;
  }

  function pushDanmu(text, isUser = false, options = {}) {
    // === æ–°å¢ï¼šåå°ä¸æ¸²æŸ“ ===
    if (document.hidden) return;
    // === ç»“æŸæ–°å¢ ===

    // === æ–°å¢ï¼šæ¢å¤ä¿æŠ¤æ‹¦æˆª ===
    if (shouldThrottle()) {
        console.log("æ¢å¤ä¿æŠ¤æœŸï¼šæ‹¦æˆªä¸€æ¡å¼¹å¹•", text);
        return; 
    }
    // === ç»“æŸæ–°å¢ ===

    const el = document.createElement("div");
    el.className = "danmu";
    el.innerText = text;
    
    // ä¿®æ”¹ä¸ºéšæœºè½¨é“
    // ä¼˜å…ˆä½¿ç”¨ options ä¸­çš„ track
    // å¦‚æœæ²¡æœ‰ä¼ å…¥ trackï¼Œä½¿ç”¨æ™ºèƒ½åˆ†é…
    const randomTrack = (typeof options.track === 'number') ? options.track : getSmartTrack();
    
    // å¦‚æœæ˜¯å¤–éƒ¨ä¼ å…¥çš„ trackï¼Œæ›´æ–°å ç”¨æ—¶é—´ï¼Œé˜²æ­¢æœ¬åœ°ç”Ÿæˆçš„æ’è½¦
    if (typeof options.track === 'number' && randomTrack < TRACK_COUNT) {
        lastTrackTime[randomTrack] = Date.now();
    }

    // ç»Ÿä¸€ä½¿ç”¨ç™¾åˆ†æ¯”å¸ƒå±€
    // è®¡ç®— top ç™¾åˆ†æ¯”
    // PC ç«¯ç‰¹æ®Šå¤„ç†ï¼šä¸ºäº†é¿å¼€å³ä¸‹è§’äºŒç»´ç ï¼Œå¼ºåˆ¶å°†å¼¹å¹•åŒºåŸŸå‹ç¼©åœ¨å±å¹•ä¸ŠåŠéƒ¨åˆ†
    // æ‰‹æœºç«¯ä¿æŒ CONFIG.DANMU_AREA_PERCENT (0.75)ï¼ŒPC ç«¯ä½¿ç”¨ 0.55
    const pcAreaPercent = 0.55; 
    const topPercent = (randomTrack / TRACK_COUNT) * pcAreaPercent * 100 + 5;
    el.style.top = topPercent + "%";
    
    // ç»Ÿä¸€æ—¶é•¿
    el.style.animationDuration = (CONFIG.DANMU_DURATION || 12) + "s";
    
    // 4. å¼¹å¹•é¢œè‰²å¤šæ ·åŒ–
    // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„ï¼Œæˆ–è€…éšæœºç»™ä¸ªé¢œè‰² (è¿™é‡Œå…¨éšæœºï¼Œä¹Ÿå¯ä¿ç•™ç™½è‰²)
    // ä¼˜å…ˆä½¿ç”¨ options ä¸­çš„ color
    el.style.color = options.color || getRandomColor();
    // ç¨å¾®åŠ ç‚¹æ–‡å­—é˜´å½±åŒºåˆ†
    el.style.textShadow = `0 0 4px rgba(0,0,0,0.8)`;

    track++;

    if (paused) {
      el.style.animationPlayState = "paused";
    }

    app.appendChild(el);
    el.addEventListener("animationend", () => el.remove());
  }

  // æ§åˆ¶æš‚åœ/ç»§ç»­
  document.getElementById("toggle").onclick = () => {
    paused = !paused;
    document.getElementById("toggle").innerText = paused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";

    // å¹¿æ’­æš‚åœ/ç»§ç»­çŠ¶æ€
    const msg = JSON.stringify({ type: "control", action: "toggle", paused });
    client.publish(topic, msg);

    document.querySelectorAll(".danmu").forEach(el => {
      el.style.animationPlayState = paused ? "paused" : "running";
    });
  };

  // æ¸…å±
  document.getElementById("clear").onclick = () => {
    // å¹¿æ’­æ¸…å±æŒ‡ä»¤
    const msg = JSON.stringify({ type: "control", action: "clear" });
    client.publish(topic, msg);

    document.querySelectorAll(".danmu").forEach(el => el.remove());
  };

  // å¯¼å‡ºæ•°æ®
  document.getElementById("download").onclick = () => {
    if (userDanmuHistory.length === 0) {
        alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");
        return;
    }
    
    // ç”Ÿæˆ TXT å†…å®¹
    const content = userDanmuHistory.map(text => {
        return `${new Date().toLocaleString()} | ${text}`;
    }).join("\n");
    
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = `danmu_backup_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    
    URL.revokeObjectURL(url);
  };

  // 3. åŠ¨æ€é€Ÿåº¦æ’­æ”¾å¾ªç¯
  function playLoop() {
    if (paused) {
      setTimeout(playLoop, 500);
      return;
    }

    let text;
    let nextDelay = 3000; // é»˜è®¤é—´éš”

    // ä¼˜å…ˆæ’­æ”¾å®æ—¶é˜Ÿåˆ—
    if (pendingDanmus.length > 0) {
      const item = pendingDanmus.shift();
      // å…¼å®¹å¯¹è±¡ç»“æ„ { text, source, track, color }
      text = (typeof item === 'object') ? item.text : item;
      const isReplay = (typeof item === 'object' && item.source === 'replay');
      
      // å¦‚æœæ²¡æœ‰æºå¸¦å‚æ•°ï¼ˆä¾‹å¦‚å›æ”¾ï¼‰ï¼Œåˆ™åœ¨æ­¤å¤„ç”Ÿæˆï¼Œç¡®ä¿æ¸²æŸ“å’Œå¹¿æ’­ä¸€è‡´
      let track = (typeof item === 'object') ? item.track : undefined;
      let color = (typeof item === 'object') ? item.color : undefined;
      
      if (track === undefined) track = getSmartTrack();
      if (!color) color = getRandomColor();

      lastUserDanmuTime = Date.now();
      nextDelay = 1000; // ç”¨æˆ·å¼¹å¹•å‘é€å¿«ä¸€ç‚¹ï¼Œ1ç§’ä¸€æ¡
      
      // ä½¿ç”¨ç¡®å®šå¥½çš„å‚æ•°æ¸²æŸ“
      pushDanmu(text, true, { track, color });

      // å¦‚æœæ˜¯å›æ”¾æ¶ˆæ¯ï¼Œå¹¿æ’­ç»™æ‰‹æœºç«¯ï¼Œæºå¸¦å‚æ•°
      if (isReplay) {
         try {
             client.publish(topic, JSON.stringify({
                 type: 'sys_danmu',
                 text: text,
                 track: track,
                 color: color
             }));
         } catch(e) {}
      }
    } else {
      // é—²æ—¶æ’­æ”¾é»˜è®¤å¼¹å¹•
      // å¦‚æœæœ€è¿‘æœ‰ç”¨æˆ·å¼¹å¹•ï¼ˆæ¯”å¦‚ 5ç§’å†…ï¼‰ï¼Œåˆ™æš‚åœæ’­æ”¾é»˜è®¤å¼¹å¹•ï¼Œæˆ–è€…å‡æ…¢é€Ÿåº¦
      const timeSinceLastUser = Date.now() - lastUserDanmuTime;
      
      if (timeSinceLastUser < 5000) {
        // æ„ŸçŸ¥åˆ°å‘é€å¼¹å¹•ï¼Œæ”¾æ…¢é»˜è®¤å¼¹å¹• (æˆ–è€…æš‚æ—¶ä¸å‘)
        // è¿™é‡Œé€‰æ‹©ï¼šæš‚æ—¶ä¸å‘ï¼Œæˆ–è€…ææ…¢
        nextDelay = 2000; 
        // ä¸ pushTextï¼Œåªæ˜¯ç©ºè½¬ç­‰å¾…ï¼Œæˆ–è€… push ä½†é—´éš”é•¿
        // ç”¨æˆ·éœ€æ±‚ï¼šå¦‚æœæœ‰æ„ŸçŸ¥åˆ°å‘é€å¼¹å¹•æ”¾æ…¢é»˜è®¤å¼¹å¹•å±•ç¤ºçš„é€Ÿåº¦
        // ç­–ç•¥ï¼šå¦‚æœæœ€è¿‘æœ‰ç”¨æˆ·å¼¹å¹•ï¼Œæˆ‘ä»¬å°±ä¸å‘é»˜è®¤å¼¹å¹•äº†ï¼Œç­‰å†·åœºäº†å†å‘
        // æˆ–è€…ï¼šå‘ï¼Œä½†æ˜¯é—´éš” 5ç§’
        if (Math.random() > 0.7) { // 30% æ¦‚ç‡å‘ä¸€æ¡ï¼Œé™ä½å¯†åº¦
             text = DEFAULT_DANMU[Math.floor(Math.random() * DEFAULT_DANMU.length)];
             
             // ç”Ÿæˆä¸€è‡´çš„å‚æ•°
              const track = getSmartTrack();
              const color = getRandomColor();
              
              pushDanmu(text, true, { track, color });
             
             // å¹¿æ’­ç»™æ‰‹æœºç«¯ï¼Œç¡®ä¿ä¸€è‡´æ€§
             try {
                client.publish(topic, JSON.stringify({
                    type: 'sys_danmu',
                    text: text,
                    track: track,
                    color: color
                }));
             } catch(e) {}

             nextDelay = 5000;
        }
      } else {
        // æ­£å¸¸å†·åœºï¼Œ3ç§’ä¸€æ¡
        text = DEFAULT_DANMU[Math.floor(Math.random() * DEFAULT_DANMU.length)];
        
        // ç”Ÿæˆä¸€è‡´çš„å‚æ•°
         const track = getSmartTrack();
         const color = getRandomColor();
 
         pushDanmu(text, true, { track, color });
        
        // å¹¿æ’­è¿™æ¡é»˜è®¤å¼¹å¹•ç»™æ‰‹æœºç«¯æ˜¾ç¤ºï¼Œä¿æŒå†…å®¹åŒæ­¥
        // ä½¿ç”¨ç‰¹æ®Šç±»å‹ä»¥å…è¢«å¤§å±ç«¯è‡ªå·±é‡å¤å¤„ç†ä¸ºç”¨æˆ·å¼¹å¹•
        try {
            client.publish(topic, JSON.stringify({
                type: 'sys_danmu',
                text: text,
                track: track,
                color: color
            }));
        } catch(e) {}

        nextDelay = 3000;
      }
    }
    
    setTimeout(playLoop, nextDelay);
  }
  
  // === æ–°å¢ï¼šLoading çŠ¶æ€ä¸å›¾ç‰‡é¢„åŠ è½½å…œåº• ===
  (function() {
    // 1. æ³¨å…¥ Loading CSS
    const style = document.createElement('style');
    style.innerHTML = `
      ._fix_loading_overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease;
      }
      ._fix_loading_spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: _fix_spin 1s ease-in-out infinite;
      }
      ._fix_loading_text {
        margin-top: 16px;
        color: #fff;
        font-size: 14px;
        opacity: 0.8;
      }
      @keyframes _fix_spin {
        to { transform: rotate(360deg); }
      }
      ._fix_fade_out {
        opacity: 0;
        pointer-events: none;
      }
    `;
    document.head.appendChild(style);

    // 2. æ’å…¥ Loading HTML
    const overlay = document.createElement('div');
    overlay.className = '_fix_loading_overlay';
    overlay.innerHTML = `
      <div class="_fix_loading_spinner"></div>
      <div class="_fix_loading_text">èµ„æºåŠ è½½ä¸­...</div>
    `;
    document.body.appendChild(overlay);

    // 3. å›¾ç‰‡é¢„åŠ è½½ä¸ç§»é™¤é€»è¾‘
    function removeLoading() {
      overlay.classList.add('_fix_fade_out');
      setTimeout(() => {
        if (overlay.parentNode) {
          overlay.parentNode.removeChild(overlay);
        }
        // ç¡®ä¿å¯åŠ¨å¾ªç¯ (å¦‚æœä¹‹å‰è¢«é˜»å¡)
        if (typeof playLoop === 'function' && !window._hasStarted) {
             window._hasStarted = true;
             playLoop();
        }
      }, 500);
    }

    // è·å–èƒŒæ™¯å›¾ URL (ä» CONFIG ä¸­)
    if (typeof CONFIG !== 'undefined' && CONFIG.BG_IMAGE) {
      console.log("[Fix] Start preloading image:", CONFIG.BG_IMAGE);
      const img = new Image();
      img.onload = () => {
        console.log("[Fix] Image loaded successfully");
        removeLoading();
      };
      img.onerror = (e) => {
        console.error("[Fix] Image load failed", e);
        removeLoading(); 
      };
      img.src = CONFIG.BG_IMAGE;

      // è¶…æ—¶å…œåº• (5ç§’)
      setTimeout(() => {
        if (!overlay.classList.contains('_fix_fade_out')) {
          console.warn("[Fix] Loading timeout");
          removeLoading();
        }
      }, 5000);
    } else {
      removeLoading();
    }
  })();
  // === ç»“æŸæ–°å¢ ===

  // å¯åŠ¨å¾ªç¯ (æ”¹ä¸ºç”± Loading å›è°ƒè§¦å‘ï¼Œæˆ–è€…å…œåº•è§¦å‘)
  // ä¸ºäº†é˜²æ­¢ Loading å¤±è´¥å¯¼è‡´ä¸è¿è¡Œï¼Œè¿™é‡Œåšä¸€ä¸ªå»¶è¿Ÿå…œåº•
  setTimeout(() => {
      if (!window._hasStarted) {
          window._hasStarted = true;
          playLoop();
      }
  }, 1000);


  // === æ–°å¢ï¼šé¡µé¢æ¢å¤ä¿æŠ¤æœºåˆ¶ ===
  // è§£å†³é—®é¢˜ï¼šé¡µé¢åˆ‡åå°å†åˆ‡å›æ—¶ï¼Œç´¯ç§¯çš„å®šæ—¶å™¨æˆ–æ¶ˆæ¯å¯èƒ½å¯¼è‡´å¼¹å¹•ç¬æ—¶çˆ†å‘
  let isRecovering = false;
  
  // ç›‘å¬å¯è§æ€§å˜åŒ–
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      console.log("é¡µé¢å¯è§ï¼Œå¯åŠ¨æ¢å¤ä¿æŠ¤...");
      isRecovering = true;
      
      // === æ–°å¢ï¼šæ¸…ç†ç§¯å‹ ===
      // å¦‚æœé˜Ÿåˆ—å¤ªé•¿ï¼Œç›´æ¥æ¸…ç©ºï¼Œé¿å…ç¬é—´çˆ†å‘
      if (pendingDanmus.length > 5) {
          console.log(`æ¸…ç†ç§¯å‹å¼¹å¹•: ${pendingDanmus.length} æ¡`);
          pendingDanmus.length = 0; 
      }
      
      // æ¸…ç†å±å¹•ä¸Šå¯èƒ½æ®‹ç•™çš„å¼¹å¹•ï¼ˆå› ä¸ºåå°æš‚åœåŠ¨ç”»å¯èƒ½å¯¼è‡´å †ç§¯ï¼‰
      document.querySelectorAll(".danmu").forEach(el => el.remove());
      
      // === ç»“æŸæ¸…ç† ===
      
      // 3ç§’åè§£é™¤ä¿æŠ¤
      setTimeout(() => {
        isRecovering = false;
        console.log("æ¢å¤ä¿æŠ¤ç»“æŸï¼Œæ­£å¸¸æ’­æ”¾");
      }, 3000);
    }
  });

  // è¾…åŠ©å‡½æ•°ï¼šé™æµæ£€æŸ¥
  // åœ¨æ¢å¤æœŸå†…ï¼Œé™åˆ¶æ¯ç§’åªèƒ½å‘ 1 æ¡
  let lastRecoverTime = 0;
  function shouldThrottle() {
    if (!isRecovering) return false;
    const now = Date.now();
    if (now - lastRecoverTime < 1000) { // 1ç§’å†…
      return true; // ä¸¢å¼ƒ/è·³è¿‡
    }
    lastRecoverTime = now;
    return false;
  }
  // === ç»“æŸæ–°å¢ ===

  // å®šæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦å›æ”¾ç”¨æˆ·å¼¹å¹•
  // è§„åˆ™ï¼šæ¯éš” REPLAY_INTERVALï¼Œå¦‚æœæ”¶é›†åˆ°çš„ç”¨æˆ·å¼¹å¹•æ•°é‡ < REPLAY_THRESHOLDï¼Œåˆ™å°†å®ƒä»¬é‡æ–°åŠ å…¥å¾…æ’­æ”¾é˜Ÿåˆ—
  /* 
  // å±è”½ç”¨æˆ·å¼¹å¹•å›æ”¾ï¼Œåªè½®æ’­é»˜è®¤åº“
  setInterval(() => {
    if (userDanmuHistory.length > 0 && userDanmuHistory.length < CONFIG.REPLAY_THRESHOLD) {
      console.log("è§¦å‘ç”¨æˆ·å¼¹å¹•å¾ªç¯å›æ”¾", userDanmuHistory);
      // å°†å†å²å¼¹å¹•æ‰“ä¹±ååŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶æ ‡è®°ä¸º replay
      const shuffled = [...userDanmuHistory].sort(() => 0.5 - Math.random());
      pendingDanmus.push(...shuffled.map(t => ({ text: t, source: 'replay' })));
    }
  }, CONFIG.REPLAY_INTERVAL);
  */

  // ç›‘å¬å¹¿æ’­
  client.on('message', (tpc, message) => {
    try {
      const msg = JSON.parse(message.toString());
      
      // å¤„ç†å¼¹å¹•
      if (msg.type === 'danmu' && msg.text) {
        const text = msg.text;
        // å®æ—¶å¼¹å¹•åŠ å…¥é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ ‡è®°ä¸º live
        // å°†é¢œè‰²å’Œè½¨é“å‚æ•°ä¹Ÿå­˜å…¥
        pendingDanmus.push({ 
          text: text, 
          source: 'live',
          track: msg.track,
          color: msg.color
        });
        // è®°å½•åˆ°å†å²
        userDanmuHistory.push(text);
        saveHistory();
      }
      
      // å¤„ç†æ§åˆ¶æŒ‡ä»¤ (å¦‚æœæ˜¯åˆ«çš„ç«¯å‘çš„)
      // æ³¨æ„ï¼šè‡ªå·±å‘çš„ä¹Ÿä¼šæ”¶åˆ°ï¼Œè¿™é‡Œéœ€è¦åŒºåˆ†å—ï¼Ÿ
      // MQTT é»˜è®¤ä¼šæ”¶åˆ°è‡ªå·±å‘çš„æ¶ˆæ¯ã€‚
      // ä¸Šé¢çš„ toggle/clear æŒ‰é’®ç‚¹å‡»æ—¶å·²ç»å¤„ç†äº†æœ¬åœ° UIï¼Œæ‰€ä»¥è¿™é‡Œå¦‚æœæ”¶åˆ°ï¼Œå¯èƒ½ä¼šé‡å¤å¤„ç†ã€‚
      // ä½† toggle æ˜¯å¹‚ç­‰çš„(set paused)ï¼Œclear ä¹Ÿæ˜¯å¹‚ç­‰çš„ã€‚
      // ä¸ºäº†é¿å…é‡å¤åŠ¨ç”»åˆ‡æ¢ï¼Œæœ€å¥½åˆ¤æ–­ä¸€ä¸‹ã€‚æˆ–è€…ä¸ç®¡ï¼Œå› ä¸º paused çŠ¶æ€ä¸€è‡´ã€‚
      
    } catch(e) {
      console.error(e);
    }
  });

  /** ===== ç”ŸæˆäºŒç»´ç  ===== */
  // åŠ¨æ€ç”ŸæˆæŒ‡å‘ mobile.html çš„é“¾æ¥
  // é™æ€éƒ¨ç½²æ—¶ï¼Œmobile.html å°±åœ¨åŒçº§ç›®å½•
  // æˆ‘ä»¬éœ€è¦æŠŠå½“å‰çš„ Topic ä¼ é€’ç»™ mobile ç«¯ï¼Œå¦åˆ™å®ƒä¸çŸ¥é“è¿å“ªä¸ª Topic
  // é€šè¿‡ URL å‚æ•°ä¼ é€’ topic
  
  const currentUrl = window.location.href;
  let mobileUrl;

  // å¤„ç† file:// åè®®
  if (currentUrl.startsWith('file://')) {
    // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶æ‰“å¼€ï¼Œç›´æ¥æ›¿æ¢æ–‡ä»¶å
    // æ³¨æ„ï¼šæ‰‹æœºæ— æ³•ç›´æ¥è®¿é—®ç”µè„‘çš„ file:// è·¯å¾„ï¼Œå¿…é¡»éƒ¨ç½²æˆ–ä½¿ç”¨ live server
    // è¿™é‡Œä¸ºäº†é€»è¾‘å®Œæ•´ç”Ÿæˆä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œä½†å®é™…ä¸Šæ‰‹æœºæ‰«ç æ‰“ä¸å¼€ file://
    // æˆ‘ä»¬æç¤ºç”¨æˆ·æœ€å¥½ç”¨ Web Server
    const path = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
    mobileUrl = path + '/mobile.html' + `?topic=${encodeURIComponent(topic)}`;
    
    // å¦‚æœæ˜¯ file åè®®ï¼Œç»™ä¸ªæç¤º
    console.warn("æ³¨æ„ï¼šå½“å‰æ˜¯ file:// åè®®ï¼Œæ‰‹æœºæ‰«ç å¯èƒ½æ— æ³•ç›´æ¥è®¿é—®ã€‚å»ºè®®ä½¿ç”¨ http æœåŠ¡å™¨ (å¦‚ Live Server, GitHub Pages).");
  } else {
    // HTTP/HTTPS åè®®
    const urlObj = new URL(currentUrl);
    // æ›¿æ¢ screen.html ä¸º mobile.html
    const pathname = urlObj.pathname.replace(/screen\.html$/, 'mobile.html');
    mobileUrl = urlObj.origin + pathname + `?topic=${encodeURIComponent(topic)}`;
  }
  
  console.log("Mobile URL:", mobileUrl);
  
  new QRCode(document.getElementById("qrcode"), {
    text: mobileUrl,
    width: 128,
    height: 128,
    colorDark : "#000000",
    colorLight : "#ffffff",
    correctLevel : QRCode.CorrectLevel.H
  });

  // å¯åŠ¨å¼¹å¹•å¾ªç¯ (å·²ç”± Loading é€»è¾‘è§¦å‘)

</script>

</body>
</html>
