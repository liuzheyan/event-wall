<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¹´ä¼šå¼¹å¹• - å¤§å±ç«¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI";
      color: #fff;
    }

    /* ===== å¤§å±ç«¯æ ·å¼ ===== */
    .screen-page {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    .mask {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 0;
    }

    .danmu {
      position: absolute;
      z-index: 1;
      white-space: nowrap;
      font-size: 26px;
      color: #fff;
      animation: move linear forwards;
      text-shadow: 0 0 8px rgba(0,0,0,0.8);
    }

    @keyframes move {
      from { transform: translateX(100vw); }
      to { transform: translateX(-100%); }
    }

    /* æ§åˆ¶é¢æ¿ */
    .control-panel {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 10;
    }

    .control-panel button {
      margin-left: 6px;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      color: #fff;
    }

    /* äºŒç»´ç å®¹å™¨ */
    .qr-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 20;
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      backdrop-filter: blur(4px);
    }
    
    .qr-container p {
      margin: 10px 0 0;
      font-size: 14px;
      color: #fff;
      font-weight: 500;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- å¼•å…¥ MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

<div id="app" class="screen-page">
  <div class="mask"></div>
  <div class="control-panel">
    <button id="toggle">â¸ æš‚åœ</button>
    <button id="clear">ğŸ§¹ æ¸…å±</button>
    <button id="download" style="display: none;">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
  </div>
  
  <!-- äºŒç»´ç å±•ç¤ºåŒº -->
  <div class="qr-container">
    <div id="qrcode"></div>
    <p>æ‰«ç å‘é€å¼¹å¹•</p>
    <p id="topic-display" style="font-size: 10px; color: #aaa; margin-top: 4px;"></p>
  </div>
</div>

<script src="js/config.js"></script>
<script>
  /** ===== é…ç½® ===== */
  // ä» CONFIG å¯¹è±¡ä¸­è¯»å–
  const { TRACK_COUNT, TRACK_HEIGHT, BG_IMAGE } = CONFIG;

  // è®¾ç½®èƒŒæ™¯å›¾
  document.getElementById("app").style.backgroundImage = `url(${BG_IMAGE})`;

  /** ===== é€šä¿¡é¢‘é“ (MQTT) ===== */
  // ä¼˜å…ˆä½¿ç”¨ CONFIG ä¸­çš„å›ºå®š Topicï¼Œæ–¹ä¾¿è°ƒè¯•
  // å¦‚æœéœ€è¦æ¯æ¬¡éšæœºï¼Œå¯ä»¥åœ¨ config.js ä¸­ä¿®æ”¹ï¼Œæˆ–è€…è¿™é‡Œè¦†ç›–
  let topic = CONFIG.MQTT_TOPIC;
  
  // æ˜¾ç¤ºå½“å‰ Topic
  document.getElementById("topic-display").innerText = "é¢‘é“: " + topic.split("/").pop(); // åªæ˜¾ç¤ºæœ€åä¸€æ®µ
  
  console.log("Connecting to MQTT Broker:", CONFIG.MQTT_BROKER);
  console.log("Topic:", topic);

  const client = mqtt.connect(CONFIG.MQTT_BROKER);

  client.on('connect', () => {
    console.log('MQTT Connected');
    client.subscribe(topic, (err) => {
      if (!err) {
        console.log('Subscribed to', topic);
      }
    });
  });

  /** ===== é€»è¾‘ ===== */
  const app = document.getElementById("app");
  let track = 0;
  let paused = false;
  let lastUserDanmuTime = 0; // ä¸Šæ¬¡æ’­æ”¾ç”¨æˆ·å¼¹å¹•çš„æ—¶é—´

  // å¾…æ’­æ”¾é˜Ÿåˆ—ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œå­˜æ”¾å®æ—¶æ¥æ”¶çš„ç”¨æˆ·å¼¹å¹•ï¼‰
  const pendingDanmus = [];
  // ç”¨æˆ·å¼¹å¹•å†å²ï¼ˆç”¨äºè®°å½•å’Œå›æ”¾ï¼‰
  // å°è¯•ä» LocalStorage è¯»å–å†å²
  let userDanmuHistory = [];
  try {
    const saved = localStorage.getItem("danmu_history");
    if (saved) userDanmuHistory = JSON.parse(saved);
  } catch(e) {}

  function saveHistory() {
      // åªä¿ç•™æœ€è¿‘ 200 æ¡
      if (userDanmuHistory.length > 200) {
          userDanmuHistory = userDanmuHistory.slice(-200);
      }
      localStorage.setItem("danmu_history", JSON.stringify(userDanmuHistory));
  }

  // è·å–éšæœºäº®è‰²
  function getRandomColor() {
    const letters = '89ABCDEF'; // é¿å…å¤ªæš—çš„é¢œè‰²
    let color = '#';
    for (let i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }

  function pushDanmu(text, isUser = false) {
    const el = document.createElement("div");
    el.className = "danmu";
    el.innerText = text;
    el.style.top = (track % TRACK_COUNT) * TRACK_HEIGHT + "px";
    el.style.animationDuration = "10s";
    
    // 4. å¼¹å¹•é¢œè‰²å¤šæ ·åŒ–
    // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„ï¼Œæˆ–è€…éšæœºç»™ä¸ªé¢œè‰² (è¿™é‡Œå…¨éšæœºï¼Œä¹Ÿå¯ä¿ç•™ç™½è‰²)
    // éœ€æ±‚ï¼šå¼¹å¹•å­—ä½“æ”¹æˆä¸æ˜¯å•ä¸€ç™½è‰²
    el.style.color = getRandomColor();
    // ç¨å¾®åŠ ç‚¹æ–‡å­—é˜´å½±åŒºåˆ†
    el.style.textShadow = `0 0 4px rgba(0,0,0,0.8)`;

    track++;

    if (paused) {
      el.style.animationPlayState = "paused";
    }

    app.appendChild(el);
    el.addEventListener("animationend", () => el.remove());
  }

  // æ§åˆ¶æš‚åœ/ç»§ç»­
  document.getElementById("toggle").onclick = () => {
    paused = !paused;
    document.getElementById("toggle").innerText = paused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";

    // å¹¿æ’­æš‚åœ/ç»§ç»­çŠ¶æ€
    const msg = JSON.stringify({ type: "control", action: "toggle", paused });
    client.publish(topic, msg);

    document.querySelectorAll(".danmu").forEach(el => {
      el.style.animationPlayState = paused ? "paused" : "running";
    });
  };

  // æ¸…å±
  document.getElementById("clear").onclick = () => {
    // å¹¿æ’­æ¸…å±æŒ‡ä»¤
    const msg = JSON.stringify({ type: "control", action: "clear" });
    client.publish(topic, msg);

    document.querySelectorAll(".danmu").forEach(el => el.remove());
  };

  // å¯¼å‡ºæ•°æ®
  document.getElementById("download").onclick = () => {
    if (userDanmuHistory.length === 0) {
        alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");
        return;
    }
    
    // ç”Ÿæˆ TXT å†…å®¹
    const content = userDanmuHistory.map(text => {
        return `${new Date().toLocaleString()} | ${text}`;
    }).join("\n");
    
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = `danmu_backup_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    
    URL.revokeObjectURL(url);
  };

  // 3. åŠ¨æ€é€Ÿåº¦æ’­æ”¾å¾ªç¯
  function playLoop() {
    if (paused) {
      setTimeout(playLoop, 500);
      return;
    }

    let text;
    let nextDelay = 3000; // é»˜è®¤é—´éš”

    // ä¼˜å…ˆæ’­æ”¾å®æ—¶é˜Ÿåˆ—
    if (pendingDanmus.length > 0) {
      text = pendingDanmus.shift();
      lastUserDanmuTime = Date.now();
      nextDelay = 1000; // ç”¨æˆ·å¼¹å¹•å‘é€å¿«ä¸€ç‚¹ï¼Œ1ç§’ä¸€æ¡
      pushDanmu(text, true);
    } else {
      // é—²æ—¶æ’­æ”¾é»˜è®¤å¼¹å¹•
      // å¦‚æœæœ€è¿‘æœ‰ç”¨æˆ·å¼¹å¹•ï¼ˆæ¯”å¦‚ 5ç§’å†…ï¼‰ï¼Œåˆ™æš‚åœæ’­æ”¾é»˜è®¤å¼¹å¹•ï¼Œæˆ–è€…å‡æ…¢é€Ÿåº¦
      const timeSinceLastUser = Date.now() - lastUserDanmuTime;
      
      if (timeSinceLastUser < 5000) {
        // æ„ŸçŸ¥åˆ°å‘é€å¼¹å¹•ï¼Œæ”¾æ…¢é»˜è®¤å¼¹å¹• (æˆ–è€…æš‚æ—¶ä¸å‘)
        // è¿™é‡Œé€‰æ‹©ï¼šæš‚æ—¶ä¸å‘ï¼Œæˆ–è€…ææ…¢
        nextDelay = 2000; 
        // ä¸ pushTextï¼Œåªæ˜¯ç©ºè½¬ç­‰å¾…ï¼Œæˆ–è€… push ä½†é—´éš”é•¿
        // ç”¨æˆ·éœ€æ±‚ï¼šå¦‚æœæœ‰æ„ŸçŸ¥åˆ°å‘é€å¼¹å¹•æ”¾æ…¢é»˜è®¤å¼¹å¹•å±•ç¤ºçš„é€Ÿåº¦
        // ç­–ç•¥ï¼šå¦‚æœæœ€è¿‘æœ‰ç”¨æˆ·å¼¹å¹•ï¼Œæˆ‘ä»¬å°±ä¸å‘é»˜è®¤å¼¹å¹•äº†ï¼Œç­‰å†·åœºäº†å†å‘
        // æˆ–è€…ï¼šå‘ï¼Œä½†æ˜¯é—´éš” 5ç§’
        if (Math.random() > 0.7) { // 30% æ¦‚ç‡å‘ä¸€æ¡ï¼Œé™ä½å¯†åº¦
             text = DEFAULT_DANMU[Math.floor(Math.random() * DEFAULT_DANMU.length)];
             pushDanmu(text);
             nextDelay = 5000;
        }
      } else {
        // æ­£å¸¸å†·åœºï¼Œ3ç§’ä¸€æ¡
        text = DEFAULT_DANMU[Math.floor(Math.random() * DEFAULT_DANMU.length)];
        pushDanmu(text);
        
        // å¹¿æ’­è¿™æ¡é»˜è®¤å¼¹å¹•ç»™æ‰‹æœºç«¯æ˜¾ç¤ºï¼Œä¿æŒå†…å®¹åŒæ­¥
        // ä½¿ç”¨ç‰¹æ®Šç±»å‹ä»¥å…è¢«å¤§å±ç«¯è‡ªå·±é‡å¤å¤„ç†ä¸ºç”¨æˆ·å¼¹å¹•
        try {
            client.publish(topic, JSON.stringify({
                type: 'sys_danmu',
                text: text
            }));
        } catch(e) {}

        nextDelay = 3000;
      }
    }
    
    setTimeout(playLoop, nextDelay);
  }
  
  // å¯åŠ¨å¾ªç¯
  playLoop();

  // å®šæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦å›æ”¾ç”¨æˆ·å¼¹å¹•
  // è§„åˆ™ï¼šæ¯éš” REPLAY_INTERVALï¼Œå¦‚æœæ”¶é›†åˆ°çš„ç”¨æˆ·å¼¹å¹•æ•°é‡ < REPLAY_THRESHOLDï¼Œåˆ™å°†å®ƒä»¬é‡æ–°åŠ å…¥å¾…æ’­æ”¾é˜Ÿåˆ—
  setInterval(() => {
    if (userDanmuHistory.length > 0 && userDanmuHistory.length < CONFIG.REPLAY_THRESHOLD) {
      console.log("è§¦å‘ç”¨æˆ·å¼¹å¹•å¾ªç¯å›æ”¾", userDanmuHistory);
      // å°†å†å²å¼¹å¹•æ‰“ä¹±ååŠ å…¥é˜Ÿåˆ—
      const shuffled = [...userDanmuHistory].sort(() => 0.5 - Math.random());
      pendingDanmus.push(...shuffled);
    }
  }, CONFIG.REPLAY_INTERVAL);

  // ç›‘å¬å¹¿æ’­
  client.on('message', (tpc, message) => {
    try {
      const msg = JSON.parse(message.toString());
      
      // å¤„ç†å¼¹å¹•
      if (msg.type === 'danmu' && msg.text) {
        const text = msg.text;
        // å®æ—¶å¼¹å¹•åŠ å…¥é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—
        pendingDanmus.push(text);
        // è®°å½•åˆ°å†å²
        userDanmuHistory.push(text);
        saveHistory();
      }
      
      // å¤„ç†æ§åˆ¶æŒ‡ä»¤ (å¦‚æœæ˜¯åˆ«çš„ç«¯å‘çš„)
      // æ³¨æ„ï¼šè‡ªå·±å‘çš„ä¹Ÿä¼šæ”¶åˆ°ï¼Œè¿™é‡Œéœ€è¦åŒºåˆ†å—ï¼Ÿ
      // MQTT é»˜è®¤ä¼šæ”¶åˆ°è‡ªå·±å‘çš„æ¶ˆæ¯ã€‚
      // ä¸Šé¢çš„ toggle/clear æŒ‰é’®ç‚¹å‡»æ—¶å·²ç»å¤„ç†äº†æœ¬åœ° UIï¼Œæ‰€ä»¥è¿™é‡Œå¦‚æœæ”¶åˆ°ï¼Œå¯èƒ½ä¼šé‡å¤å¤„ç†ã€‚
      // ä½† toggle æ˜¯å¹‚ç­‰çš„(set paused)ï¼Œclear ä¹Ÿæ˜¯å¹‚ç­‰çš„ã€‚
      // ä¸ºäº†é¿å…é‡å¤åŠ¨ç”»åˆ‡æ¢ï¼Œæœ€å¥½åˆ¤æ–­ä¸€ä¸‹ã€‚æˆ–è€…ä¸ç®¡ï¼Œå› ä¸º paused çŠ¶æ€ä¸€è‡´ã€‚
      
    } catch(e) {
      console.error(e);
    }
  });

  /** ===== ç”ŸæˆäºŒç»´ç  ===== */
  // åŠ¨æ€ç”ŸæˆæŒ‡å‘ mobile.html çš„é“¾æ¥
  // é™æ€éƒ¨ç½²æ—¶ï¼Œmobile.html å°±åœ¨åŒçº§ç›®å½•
  // æˆ‘ä»¬éœ€è¦æŠŠå½“å‰çš„ Topic ä¼ é€’ç»™ mobile ç«¯ï¼Œå¦åˆ™å®ƒä¸çŸ¥é“è¿å“ªä¸ª Topic
  // é€šè¿‡ URL å‚æ•°ä¼ é€’ topic
  
  const currentUrl = window.location.href;
  let mobileUrl;

  // å¤„ç† file:// åè®®
  if (currentUrl.startsWith('file://')) {
    // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶æ‰“å¼€ï¼Œç›´æ¥æ›¿æ¢æ–‡ä»¶å
    // æ³¨æ„ï¼šæ‰‹æœºæ— æ³•ç›´æ¥è®¿é—®ç”µè„‘çš„ file:// è·¯å¾„ï¼Œå¿…é¡»éƒ¨ç½²æˆ–ä½¿ç”¨ live server
    // è¿™é‡Œä¸ºäº†é€»è¾‘å®Œæ•´ç”Ÿæˆä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œä½†å®é™…ä¸Šæ‰‹æœºæ‰«ç æ‰“ä¸å¼€ file://
    // æˆ‘ä»¬æç¤ºç”¨æˆ·æœ€å¥½ç”¨ Web Server
    const path = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
    mobileUrl = path + '/mobile.html' + `?topic=${encodeURIComponent(topic)}`;
    
    // å¦‚æœæ˜¯ file åè®®ï¼Œç»™ä¸ªæç¤º
    console.warn("æ³¨æ„ï¼šå½“å‰æ˜¯ file:// åè®®ï¼Œæ‰‹æœºæ‰«ç å¯èƒ½æ— æ³•ç›´æ¥è®¿é—®ã€‚å»ºè®®ä½¿ç”¨ http æœåŠ¡å™¨ (å¦‚ Live Server, GitHub Pages).");
  } else {
    // HTTP/HTTPS åè®®
    const urlObj = new URL(currentUrl);
    // æ›¿æ¢ screen.html ä¸º mobile.html
    const pathname = urlObj.pathname.replace(/screen\.html$/, 'mobile.html');
    mobileUrl = urlObj.origin + pathname + `?topic=${encodeURIComponent(topic)}`;
  }
  
  console.log("Mobile URL:", mobileUrl);
  
  new QRCode(document.getElementById("qrcode"), {
    text: mobileUrl,
    width: 128,
    height: 128,
    colorDark : "#000000",
    colorLight : "#ffffff",
    correctLevel : QRCode.CorrectLevel.H
  });

</script>

</body>
</html>
