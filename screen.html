<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¹´ä¼šå¼¹å¹• - å¤§å±ç«¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI";
      color: #fff;
    }

    /* ===== å¤§å±ç«¯æ ·å¼ ===== */
    .screen-page {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    .mask {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 0;
    }

    .danmu {
      position: absolute;
      z-index: 1;
      white-space: nowrap;
      font-size: 26px;
      color: #fff;
      animation: move linear forwards;
      text-shadow: 0 0 8px rgba(0,0,0,0.8);
    }

    @keyframes move {
      from { transform: translateX(100vw); }
      to { transform: translateX(-100%); }
    }

    /* æ§åˆ¶é¢æ¿ */
    .control-panel {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 10;
    }

    .control-panel button {
      margin-left: 6px;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      color: #fff;
    }

    /* äºŒç»´ç å®¹å™¨ */
    .qr-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 20;
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      backdrop-filter: blur(4px);
    }
    
    .qr-container p {
      margin: 10px 0 0;
      font-size: 14px;
      color: #fff;
      font-weight: 500;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

<div id="app" class="screen-page">
  <div class="mask"></div>
  <div class="control-panel">
    <button id="toggle">â¸ æš‚åœ</button>
    <button id="clear">ğŸ§¹ æ¸…å±</button>
  </div>
  
  <!-- äºŒç»´ç å±•ç¤ºåŒº -->
  <div class="qr-container">
    <div id="qrcode"></div>
    <p>æ‰«ç å‘é€å¼¹å¹•</p>
  </div>
</div>

<script src="js/config.js"></script>
<script>
  /** ===== é…ç½® ===== */
  // ä» CONFIG å¯¹è±¡ä¸­è¯»å–
  const { TRACK_COUNT, TRACK_HEIGHT, BG_IMAGE } = CONFIG;

  // è®¾ç½®èƒŒæ™¯å›¾
  document.getElementById("app").style.backgroundImage = `url(${BG_IMAGE})`;

  /** ===== é€šä¿¡é¢‘é“ ===== */
  const channel = new BroadcastChannel("danmu_channel");

  /** ===== é€»è¾‘ ===== */
  const app = document.getElementById("app");
  let track = 0;
  let paused = false;

  // å¾…æ’­æ”¾é˜Ÿåˆ—ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œå­˜æ”¾å®æ—¶æ¥æ”¶çš„ç”¨æˆ·å¼¹å¹•ï¼‰
  const pendingDanmus = [];
  // ç”¨æˆ·å¼¹å¹•å†å²ï¼ˆç”¨äºè®°å½•å’Œå›æ”¾ï¼‰
  const userDanmuHistory = [];

  function pushDanmu(text) {
    const el = document.createElement("div");
    el.className = "danmu";
    el.innerText = text;
    el.style.top = (track % TRACK_COUNT) * TRACK_HEIGHT + "px";
    el.style.animationDuration = "10s";
    track++;

    if (paused) {
      el.style.animationPlayState = "paused";
    }

    app.appendChild(el);
    el.addEventListener("animationend", () => el.remove());
  }

  // æ§åˆ¶æš‚åœ/ç»§ç»­
  document.getElementById("toggle").onclick = () => {
    paused = !paused;
    document.getElementById("toggle").innerText = paused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";

    // å¹¿æ’­æš‚åœ/ç»§ç»­çŠ¶æ€
    channel.postMessage({ type: "control", action: "toggle", paused });

    document.querySelectorAll(".danmu").forEach(el => {
      el.style.animationPlayState = paused ? "paused" : "running";
    });
  };

  // æ¸…å±
  document.getElementById("clear").onclick = () => {
    // å¹¿æ’­æ¸…å±æŒ‡ä»¤
    channel.postMessage({ type: "control", action: "clear" });

    document.querySelectorAll(".danmu").forEach(el => el.remove());
  };

  // å¼¹å¹•å¾ªç¯æ’­æ”¾å™¨
  setInterval(() => {
    if (paused) return;

    let text;
    // ä¼˜å…ˆæ’­æ”¾å®æ—¶é˜Ÿåˆ—
    if (pendingDanmus.length > 0) {
      text = pendingDanmus.shift();
    } else {
      // é—²æ—¶æ’­æ”¾é»˜è®¤å¼¹å¹•
      text = DEFAULT_DANMU[Math.floor(Math.random() * DEFAULT_DANMU.length)];
    }
    
    pushDanmu(text);
  }, 3000);

  // å®šæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦å›æ”¾ç”¨æˆ·å¼¹å¹•
  // è§„åˆ™ï¼šæ¯éš” REPLAY_INTERVALï¼Œå¦‚æœæ”¶é›†åˆ°çš„ç”¨æˆ·å¼¹å¹•æ•°é‡ < REPLAY_THRESHOLDï¼Œåˆ™å°†å®ƒä»¬é‡æ–°åŠ å…¥å¾…æ’­æ”¾é˜Ÿåˆ—
  setInterval(() => {
    if (userDanmuHistory.length > 0 && userDanmuHistory.length < CONFIG.REPLAY_THRESHOLD) {
      console.log("è§¦å‘ç”¨æˆ·å¼¹å¹•å¾ªç¯å›æ”¾", userDanmuHistory);
      // å°†å†å²å¼¹å¹•æ‰“ä¹±ååŠ å…¥é˜Ÿåˆ—
      const shuffled = [...userDanmuHistory].sort(() => 0.5 - Math.random());
      pendingDanmus.push(...shuffled);
    }
  }, CONFIG.REPLAY_INTERVAL);

  // ç›‘å¬å¹¿æ’­
  channel.onmessage = e => {
    // å¦‚æœæ˜¯å¼¹å¹•æ¶ˆæ¯
    if (e.data.text) {
      const text = e.data.text;
      // å®æ—¶å¼¹å¹•åŠ å…¥é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—
      pendingDanmus.push(text);
      // è®°å½•åˆ°å†å²
      userDanmuHistory.push(text);
    }
  };

  /** ===== ç”ŸæˆäºŒç»´ç  ===== */
  new QRCode(document.getElementById("qrcode"), {
    text: "https://liuzheyan.github.io/event-wall/mobile.html",
    width: 128,
    height: 128,
    colorDark : "#000000",
    colorLight : "#ffffff",
    correctLevel : QRCode.CorrectLevel.H
  });

</script>

</body>
</html>
